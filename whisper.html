<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="./lib/web3.min.js"></script>
<script src="http://code.jquery.com/jquery-latest.js "></script>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
<link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' type='text/css'>

<body class="container">
  <h1>whisper test</h1>
  <div class="form-row">
      <div class="form-group">
        <label for="i_topic">Room Code</label>
        <input type="text" class="form-control" id="i_topic" />
      </div>
      <button type="button" name="button" id="join_btn" class="btn btn-success">입장</button>
  </div>
  <div class="row">
      <div id="log">
      </div>
  </div>
  <div class="form-row">
      <div class="form-group">
        <label for="t_payload">Message</label>
        <textarea id="t_payload" class="form-control"></textarea>
      </div>
      <button type="button" name="button" id="send_btn" class="btn btn-primary">보내기</button>
  </div>
</body>

<script>
  // web3 연동
  var Web3 = require('web3');
  var web3 = new Web3();
  web3.setProvider(new web3.providers.HttpProvider("http://192.168.0.106:8545"));

  let i_topic;
  let t_payload;

  let log_list = document.getElementById("log")

  let btn_join = document.getElementById("join_btn")
  let btn_send = document.getElementById("send_btn")

  // 방이름을 입력하여 해당 Topic으로 입장
  let rooms = []
  btn_join.onclick = () => {

    log_list.innerHTML = ''
    i_topic = document.getElementById("i_topic").value
    filtering()
  }

  btn_send.onclick = () => {
    t_payload = document.getElementById("t_payload").value

    web3.shh.post(
      {
        topics : [i_topic],
        payload : web3.fromUtf8(t_payload),
        ttl : web3.fromDecimal("100")
      }
    )
  }

  // filter를 이용해 topic들의 변화를 감지 한다.
  let filtering = () => {
    let filter = web3.shh.filter({ topics: [i_topic] });
    
    filter.watch((error, result) => {
      if(!error) {
        var topics = filter.options.topics ;
        var message = web3.toUtf8(result.payload);
        log_list.innerHTML += "<div> Topic: " + web3.toUtf8(parseInt(topics).toString(16)) + "</div>"
                            + "<div> " + new Date(result.sent*1000) + "</div>"
                            + "<div> " + message + "</div>";
        }
    })
  }

</script>

</html>
